{{ define "main" }}
    {{/* 顶部页眉 / 封面图区域 */}}
    <header class="moments-header" style="background-image: url('{{ .Site.Params.cover | default ( "images/cover.jpg" | relURL ) }}');">
        <div class="header-user">
            <div class="header-avatar">
                <img src="{{ .Site.Params.avatar | default ( "images/avatar.jpg" | relURL ) }}" alt="Avatar">
            </div>
            <div class="header-info">
                <h1 class="header-name">{{ .Site.Params.username | default .Site.Title }}</h1>
            </div>
        </div>
    </header>
    
    {{/* 个人签名（放在封面图下面） */}}
    <div class="header-signature">
        {{ .Site.Params.description }}
    </div>

    {{/* 动态列表（信息流） */}}
    <main class="moments-feed">
        {{ range (where .Site.RegularPages "Section" "posts").ByDate.Reverse }}
        <article class="moment-card" id="post-{{ .File.UniqueID }}">
            
            {{/* 左侧：头像 */}}
            <aside class="moment-aside">
                <img class="avatar-img" src="{{ .Params.avatar | default $.Site.Params.avatar | default ( "images/avatar.jpg" | relURL ) }}" alt="User" loading="lazy">
            </aside>

            {{/* 右侧：动态主体 */}}
            <div class="moment-body">
                <h2 class="moment-author">{{ .Params.author | default $.Site.Params.username }}</h2>
                
                {{/* 文字内容 */}}
                <div class="moment-text-wrapper">
                    <div class="moment-text is-collapsed">
                        {{/* 剔除正文里已经渲染的 <img> 标签，防止首页预览时图片重复显示 */}}
                        {{ .Content | replaceRE "(?s)<img[^>]*>" "" | replaceRE "<p>\\s*</p>" "" | safeHTML }}
                    </div>
                    <button class="text-toggle" style="display: none;">全文</button>
                </div>

                {{/* 图片画廊（九宫格） */}}
                {{ $images := .Params.images }}
                {{/* 如果 Front Matter 里没写图片，就从正文里抓取 */}}
                {{ if not $images }}
                    {{/* 这里的正则会匹配所有 <img> 的 src 属性 */}}
                    {{ $imgTags := findRE "<img[^>]+src=\"([^\"]+)\"[^>]*>" .Content }}
                    {{ if $imgTags }}
                        {{ $images = slice }}
                        {{ range $imgTags }}
                            {{ $src := replaceRE "<img[^>]+src=\"([^\"]+)\"[^>]*>" "$1" . }}
                            {{ $images = $images | append $src }}
                        {{ end }}
                        {{ $images = $images | uniq }}
                    {{ end }}
                {{ end }}

                {{ if $images }}
                {{ $currentPage := . }}
                <div class="moment-gallery">
                    {{ $len := len $images }}
                    {{ if eq $len 1 }}
                        {{/* 只有一张图时的展示方式 */}}
                        <div class="gallery-single">
                            {{ range $images }}
                                {{ $imgSrc := . }}
                                {{ if not (findRE "^(http|/)" $imgSrc) }}
                                    {{ with $currentPage.Resources.GetMatch $imgSrc }}
                                        {{ $imgSrc = .RelPermalink }}
                                    {{ end }}
                                {{ end }}
                                <img src="{{ $imgSrc }}" alt="Image" loading="lazy">
                            {{ end }}
                        </div>
                    {{ else }}
                        {{/* 多张图时的九宫格布局 */}}
                        <div class="gallery-grid {{ if or (eq $len 2) (eq $len 4) }}cols-2{{ else }}cols-3{{ end }}">
                            {{ range $images }}
                                {{ $imgSrc := . }}
                                {{ if not (findRE "^(http|/)" $imgSrc) }}
                                    {{ with $currentPage.Resources.GetMatch $imgSrc }}
                                        {{ $imgSrc = .RelPermalink }}
                                    {{ end }}
                                {{ end }}
                                <div class="gallery-item">
                                    <img src="{{ $imgSrc }}" alt="Image" loading="lazy">
                                </div>
                            {{ end }}
                        </div>
                    {{ end }}
                </div>
                {{ end }}

                {{/* 时间、地点与操作按钮 */}}
                <footer class="moment-footer">
                    <div class="footer-meta">
                        <span class="moment-time">{{ .Date.Format "2006年1月2号" }}</span>
                        {{ if .Params.location }}
                        <span class="moment-location">{{ .Params.location }}</span>
                        {{ end }}
                    </div>
                    
                    {{/* 右侧的操作菜单（点赞/评论） */}}
                    <div class="action-wrapper">
                        {{ if and (eq .Site.Params.commentMode "artalk") .Site.Params.artalkServer }}
                        <button class="action-toggle" aria-label="Toggle Actions">
                            <i class="ri-more-fill"></i>
                        </button>
                        
                        {{/* 弹出的小黑框 */}}
                        <div class="action-popover">
                            <button class="popover-btn btn-like">
                                <i class="ri-heart-line"></i>
                                赞
                            </button>
                            <span class="popover-divider"></span>
                            <a href="{{ .Permalink }}#comments-single" class="popover-btn">
                                <i class="ri-chat-3-line"></i>
                                评论
                            </a>
                        </div>
                        {{ else }}
                        <a href="{{ .Permalink }}" class="action-link-more" title="查看详情">
                            <i class="ri-more-fill"></i>
                        </a>
                        {{ end }}
                    </div>
                </footer>

                {{/* 首页评论展示区 - 朋友圈风格（只读） */}}
                {{ if and (eq .Site.Params.commentMode "artalk") .Site.Params.artalkServer }}
                <div class="moment-comments-area feed-comments" id="comments-{{ .File.UniqueID }}" data-page-key="{{ .Permalink }}">
                    <div class="moment-likes">
                        <i class="ri-heart-3-line"></i>
                        <span class="moment-likes-list"></span>
                    </div>
                </div>
                {{ end }}
            </div>
        </article>
        {{ end }}
    </main>
{{ end }}